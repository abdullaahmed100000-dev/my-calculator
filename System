pos_desktop.pyÂ Â (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ø¬Ø§Ù‡Ø²Ø© Â Ù„Ù„Ù†Ø³Ø®)
import os import zipfile import shutil import datetime import threading import time import sys from decimal import Decimal from flask import Flask, render_template_string, request, redirect, url_for, jsonify, flash from flask_sqlalchemy import SQLAlchemy from datetime import datetime, date from sqlalchemy import extract
PyQt (ÙˆØ§Ø¬Ù‡Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨)
from PyQt5.QtWidgets import QMessageBox from PyQt5.QtWidgets import QApplication, QMainWindow, QVBoxLayout, QWidget, QPushButton, QHBoxLayout from PyQt5.QtWebEngineWidgets import QWebEngineView from PyQt5.QtCore import QUrl
Ø·Ø¨Ø§Ø¹Ø© ÙˆÙŠÙ†Ø¯ÙˆØ² ÙˆPDF
try: Â Â Â Â import win32print Â Â Â Â import win32api except Exception: Â Â Â Â win32print = None Â Â Â Â win32api = None from reportlab.lib.pagesizes import A4 from reportlab.pdfgen import canvas
---------------- Flask app & DB ----------------
app = Flask(name) app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///data.db' app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False app.config['SECRET_KEY'] = 'replace-this-with-a-secure-key' db = SQLAlchemy(app)
---------------- Models ----------------
class Product(db.Model): Â Â Â Â id = db.Column(db.Integer, primary_key=True) Â Â Â Â barcode = db.Column(db.String(64), unique=True, nullable=True) Â Â Â Â name = db.Column(db.String(200), nullable=False) Â Â Â Â price = db.Column(db.Numeric(10, 2), nullable=False) Â Â Â Â cost = db.Column(db.Numeric(10, 2), nullable=True) Â Â Â Â quantity = db.Column(db.Numeric(10, 3), nullable=False, default=0) Â Â Â Â unit = db.Column(db.String(20), default='pcs') Â Â Â Â expiry = db.Column(db.Date, nullable=True) class Sale(db.Model): Â Â Â Â id = db.Column(db.Integer, primary_key=True) Â Â Â Â timestamp = db.Column(db.DateTime, default=datetime.utcnow) Â Â Â Â total = db.Column(db.Numeric(12, 2), nullable=False) Â Â Â Â items = db.relationship('SaleItem', backref='sale', cascade='all, delete-orphan') class SaleItem(db.Model): Â Â Â Â id = db.Column(db.Integer, primary_key=True) Â Â Â Â sale_id = db.Column(db.Integer, db.ForeignKey('sale.id'), nullable=False) Â Â Â Â product_id = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False) Â Â Â Â product = db.relationship('Product') Â Â Â Â qty = db.Column(db.Numeric(10, 3), nullable=False) Â Â Â Â price = db.Column(db.Numeric(10, 2), nullable=False) class Expense(db.Model): Â Â Â Â id = db.Column(db.Integer, primary_key=True) Â Â Â Â timestamp = db.Column(db.DateTime, default=datetime.utcnow) Â Â Â Â amount = db.Column(db.Numeric(12,2), nullable=False) Â Â Â Â description = db.Column(db.String(400), nullable=True)
---------------- Helpers ----------------
def init_db(): Â Â Â Â db.create_all() Â Â Â Â # add some sample products if empty Â Â Â Â if Product.query.count() == 0: Â Â Â Â Â Â Â Â p1 = Product(barcode='6291041500213', name='Ø£Ø±Ø² 1ÙƒØ¬Ù…', price=Decimal('40.00'), cost=Decimal('30.00'), quantity=Decimal('50'), unit='kg') Â Â Â Â Â Â Â Â p2 = Product(barcode='6291041500214', name='Ø­Ù„ÙŠØ¨ 1Ù„ØªØ±', price=Decimal('25.00'), cost=Decimal('18.00'), quantity=Decimal('100'), unit='pcs') Â Â Â Â Â Â Â Â p3 = Product(barcode='6291041500215', name='Ø³ÙƒØ± 1ÙƒØ¬Ù…', price=Decimal('35.00'), cost=Decimal('25.00'), quantity=Decimal('40'), unit='kg') Â Â Â Â Â Â Â Â db.session.add_all([p1, p2, p3]) Â Â Â Â Â Â Â Â db.session.commit() def decimal_to_str(d): Â Â Â Â if d is None: Â Â Â Â Â Â Â Â return "0" Â Â Â Â return format(d, 'f')
---------------- Printing / Invoice ----------------
def print_invoice_auto(invoice_data): Â Â Â Â file_name = f"invoice_{invoice_data['invoice_id']}.pdf" Â Â Â Â pdf_path = os.path.join(os.getcwd(), file_name) Â Â Â Â c = canvas.Canvas(pdf_path, pagesize=A4) Â Â Â Â width, height = A4 Â Â Â Â c.setFont("Helvetica-Bold", 18) Â Â Â Â c.drawCentredString(width / 2, height - 50, invoice_data["store_name"]) Â Â Â Â c.setFont("Helvetica", 12) Â Â Â Â c.drawString(40, height - 80, f"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {invoice_data['invoice_id']}") Â Â Â Â c.drawString(400, height - 80, f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}") Â Â Â Â y = height - 120 Â Â Â Â c.setFont("Helvetica-Bold", 12) Â Â Â Â c.drawString(50, y, "Ø§Ù„Ù…Ù†ØªØ¬") Â Â Â Â c.drawString(250, y, "Ø§Ù„Ø³Ø¹Ø±") Â Â Â Â c.drawString(350, y, "Ø§Ù„ÙƒÙ…ÙŠØ©") Â Â Â Â c.drawString(450, y, "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ") Â Â Â Â c.setFont("Helvetica", 11) Â Â Â Â y -= 20 Â Â Â Â for item in invoice_data["products"]: Â Â Â Â Â Â Â Â total_price = float(item["price"]) * float(item["quantity"]) Â Â Â Â Â Â Â Â c.drawString(50, y, item["name"]) Â Â Â Â Â Â Â Â c.drawString(250, y, f"{float(item['price']):.2f}") Â Â Â Â Â Â Â Â c.drawString(350, y, str(item["quantity"])) Â Â Â Â Â Â Â Â c.drawString(450, y, f"{total_price:.2f}") Â Â Â Â Â Â Â Â y -= 20 Â Â Â Â c.setFont("Helvetica-Bold", 13) Â Â Â Â c.drawString(50, y - 20, f"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: {float(invoice_data['total']):.2f} Ø¬Ù†ÙŠÙ‡") Â Â Â Â c.showPage() Â Â Â Â c.save() Â Â Â Â # Try print via default printer, otherwise open PDF Â Â Â Â try: Â Â Â Â Â Â Â Â if win32print: Â Â Â Â Â Â Â Â Â Â Â Â printer_name = win32print.GetDefaultPrinter() Â Â Â Â Â Â Â Â Â Â Â Â if printer_name: Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â win32api.ShellExecute(0, "print", pdf_path, None, ".", 0) Â Â Â Â Â Â Â Â Â Â Â Â else: Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â raise Exception("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ø¨Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©") Â Â Â Â Â Â Â Â else: Â Â Â Â Â Â Â Â Â Â Â Â raise Exception("ÙˆØ­Ø¯Ø© win32 Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©") Â Â Â Â except Exception as e: Â Â Â Â Â Â Â Â try: Â Â Â Â Â Â Â Â Â Â Â Â msg = QMessageBox() Â Â Â Â Â Â Â Â Â Â Â Â msg.setIcon(QMessageBox.Warning) Â Â Â Â Â Â Â Â Â Â Â Â msg.setWindowTitle("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©") Â Â Â Â Â Â Â Â Â Â Â Â msg.setText("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ø¨Ø¹Ø© Ù…ØªØµÙ„Ø©!\nØ³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¯Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.") Â Â Â Â Â Â Â Â Â Â Â Â msg.exec_() Â Â Â Â Â Â Â Â except Exception: Â Â Â Â Â Â Â Â Â Â Â Â pass Â Â Â Â Â Â Â Â os.startfile(pdf_path)
---------------- Update utilities ----------------
def is_update_available(): Â Â Â Â """ÙŠÙØ­Øµ Ù…Ø¬Ù„Ø¯ updates Ø¥Ø°Ø§ ÙÙŠ Ù…Ù„ÙØ§Øª zip ÙˆÙŠÙ‚Ø§Ø±Ù† Ù…Ø¹ version.txt""" Â Â Â Â try: Â Â Â Â Â Â Â Â updates_folder = os.path.join(os.getcwd(), "updates") Â Â Â Â Â Â Â Â version_file = os.path.join(os.getcwd(), "version.txt") Â Â Â Â Â Â Â Â if not os.path.exists(version_file): Â Â Â Â Â Â Â Â Â Â Â Â with open(version_file, "w") as f: Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â f.write("1.0") Â Â Â Â Â Â Â Â with open(version_file, "r") as f: Â Â Â Â Â Â Â Â Â Â Â Â current_version = f.read().strip() Â Â Â Â Â Â Â Â if not os.path.exists(updates_folder): Â Â Â Â Â Â Â Â Â Â Â Â return False, None Â Â Â Â Â Â Â Â update_files = sorted([f for f in os.listdir(updates_folder) if f.endswith(".zip")], reverse=True) Â Â Â Â Â Â Â Â if not update_files: Â Â Â Â Â Â Â Â Â Â Â Â return False, None Â Â Â Â Â Â Â Â update_name = update_files[0] Â Â Â Â Â Â Â Â update_version = update_name.replace(".zip","") Â Â Â Â Â Â Â Â return (update_version > current_version), os.path.join(updates_folder, update_name) Â Â Â Â except Exception: Â Â Â Â Â Â Â Â return False, None def apply_update_from_zip(zip_path): Â Â Â Â """ÙŠÙÙƒ zip ÙˆÙŠØ­Ø¯Ø« Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¯ÙˆÙ† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª""" Â Â Â Â try: Â Â Â Â Â Â Â Â if not os.path.exists(zip_path): Â Â Â Â Â Â Â Â Â Â Â Â return False, "Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" Â Â Â Â Â Â Â Â temp_dir = os.path.join(os.getcwd(), "temp_update") Â Â Â Â Â Â Â Â if os.path.exists(temp_dir): Â Â Â Â Â Â Â Â Â Â Â Â shutil.rmtree(temp_dir) Â Â Â Â Â Â Â Â with zipfile.ZipFile(zip_path, 'r') as zip_ref: Â Â Â Â Â Â Â Â Â Â Â Â zip_ref.extractall(temp_dir) Â Â Â Â Â Â Â Â # determine new version Â Â Â Â Â Â Â Â new_version = None Â Â Â Â Â Â Â Â vfile = os.path.join(temp_dir, "version.txt") Â Â Â Â Â Â Â Â if os.path.exists(vfile): Â Â Â Â Â Â Â Â Â Â Â Â with open(vfile, "r") as f: Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â new_version = f.read().strip() Â Â Â Â Â Â Â Â else: Â Â Â Â Â Â Â Â Â Â Â Â new_version = os.path.basename(zip_path).replace(".zip","") Â Â Â Â Â Â Â Â # copy files (overwrite) Â Â Â Â Â Â Â Â for item in os.listdir(temp_dir): Â Â Â Â Â Â Â Â Â Â Â Â s = os.path.join(temp_dir, item) Â Â Â Â Â Â Â Â Â Â Â Â d = os.path.join(os.getcwd(), item) Â Â Â Â Â Â Â Â Â Â Â Â # don't allow overwriting backup folder Â Â Â Â Â Â Â Â Â Â Â Â if os.path.basename(s).lower() == "backup": Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â continue Â Â Â Â Â Â Â Â Â Â Â Â if os.path.isdir(s): Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â shutil.copytree(s, d, dirs_exist_ok=True) Â Â Â Â Â Â Â Â Â Â Â Â else: Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â shutil.copy2(s, d) Â Â Â Â Â Â Â Â shutil.rmtree(temp_dir) Â Â Â Â Â Â Â Â with open(os.path.join(os.getcwd(), "version.txt"), "w") as f: Â Â Â Â Â Â Â Â Â Â Â Â f.write(str(new_version)) Â Â Â Â Â Â Â Â return True, new_version Â Â Â Â except Exception as e: Â Â Â Â Â Â Â Â return False, str(e)
---------------- Backup utilities ----------------
def create_backup(data_file_path): Â Â Â Â """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù…Ù„Ù data.db""" Â Â Â Â try: Â Â Â Â Â Â Â Â if not os.path.exists(data_file_path): Â Â Â Â Â Â Â Â Â Â Â Â raise FileNotFoundError("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.") Â Â Â Â Â Â Â Â backup_dir = os.path.join(os.getcwd(), "backup") Â Â Â Â Â Â Â Â os.makedirs(backup_dir, exist_ok=True) Â Â Â Â Â Â Â Â file_name = os.path.basename(data_file_path) Â Â Â Â Â Â Â Â timestamp = datetime.now().strftime("%Y%m%d_%H%M%S") Â Â Â Â Â Â Â Â backup_name = f"backup_{timestamp}{file_name}" Â Â Â Â Â Â Â Â backup_path = os.path.join(backup_dir, backup_name) Â Â Â Â Â Â Â Â shutil.copy2(data_file_path, backup_path) Â Â Â Â Â Â Â Â print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­: {backup_name}") Â Â Â Â except Exception as e: Â Â Â Â Â Â Â Â try: Â Â Â Â Â Â Â Â Â Â Â Â msg = QMessageBox() Â Â Â Â Â Â Â Â Â Â Â Â msg.setIcon(QMessageBox.Warning) Â Â Â Â Â Â Â Â Â Â Â Â msg.setWindowTitle("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ") Â Â Â Â Â Â Â Â Â Â Â Â msg.setText(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:\n{e}") Â Â Â Â Â Â Â Â Â Â Â Â msg.exec() Â Â Â Â Â Â Â Â except Exception: Â Â Â Â Â Â Â Â Â Â Â Â pass Â Â Â Â Â Â Â Â raise def restore_backup(data_file_path): Â Â Â Â """Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§""" Â Â Â Â try: Â Â Â Â Â Â Â Â backup_dir = os.path.join(os.getcwd(), "backup") Â Â Â Â Â Â Â Â if not os.path.exists(backup_dir) or not os.listdir(backup_dir): Â Â Â Â Â Â Â Â Â Â Â Â raise FileNotFoundError("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.") Â Â Â Â Â Â Â Â backups = sorted(os.listdir(backup_dir), reverse=True) Â Â Â Â Â Â Â Â latest_backup = backups[0] Â Â Â Â Â Â Â Â latest_backup_path = os.path.join(backup_dir, latest_backup) Â Â Â Â Â Â Â Â shutil.copy2(latest_backup_path, data_file_path) Â Â Â Â Â Â Â Â print(f"â™»ï¸ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø©: {latest_backup}") Â Â Â Â except Exception as e: Â Â Â Â Â Â Â Â try: Â Â Â Â Â Â Â Â Â Â Â Â msg = QMessageBox() Â Â Â Â Â Â Â Â Â Â Â Â msg.setIcon(QMessageBox.Warning) Â Â Â Â Â Â Â Â Â Â Â Â msg.setWindowTitle("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹") Â Â Â Â Â Â Â Â Â Â Â Â msg.setText(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:\n{e}") Â Â Â Â Â Â Â Â Â Â Â Â msg.exec_() Â Â Â Â Â Â Â Â except Exception: Â Â Â Â Â Â Â Â Â Â Â Â pass Â Â Â Â Â Â Â Â raise
---------------- Templates (HTML) ----------------
HOME_HTML = """(ØªÙ… ØªÙ‚ØµÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ù‡Ù†Ø§ â€” ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© Ø£Ø¯Ù†Ø§Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)"""
Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ ØµÙØ­Ø§Øª HTML Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± â€” Ø³Ù†Ø¹Ø±ÙÙ„Ù‡Ø§ Ø£Ø¯Ù†Ø§Ù‡
HOME_HTML = """ Â Â Â Â Â Â Â Â Â Â Â Ø³Ø§Ø³ØªÙ… - Ù„Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ø¹Ù…Ø§Ù„Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø®Ø±ÙˆØ¬Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Ø³Ø³ØªÙ…Â Â - Ù„Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ø§Ø¹Ù…Ø§Ù„ (ÙØ±Ø¹ ÙˆØ§Ø­Ø¯)
Â Â Â Â 
Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø³Ø­ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ø³Ù…)
Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¶Ø§ÙØ©Â Â Â Â Â Â Â  Â Â Â Â 
Ø§Ù„Ø³Ù„Ø©
Â Â Â Â  Â Â Â Â Â Â Â Â  Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¬Ù†ÙŠÙ‡ Â Â Â Â Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹Â Â Â Â Â Â Â Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„Â Â Â Â Â Â Â  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† | ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Â Â Â Â Â Â Â Â Â Â """Â Â Â REPORTS_HTML = """Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
Â Â Â Â Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: {{ daily_total }} Ø¬Ù†ÙŠÙ‡ |Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...Â Â Â Â Â Â Â  Â Â Â Â  Â Â Â Â Â Â Â Â ğŸ—‘ï¸ Ù…Ø³Ø­ Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…Â Â Â Â Â Â Â Â Â Â Â ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©Â Â Â Â Â Â Â Â Â Â Â â™»ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©Â Â Â Â Â Â Â Â Â Â Â ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªÂ Â Â Â Â Â Â Â Â Â Â ğŸ” ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« â€” Ø§Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØªÂ Â Â Â Â Â Â  Â Â Â Â 
Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ù‹Ø§
Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {% for item in top_products %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ item.name }} {{ item.total_qty }} {{ item.total_revenue }} Â Â Â Â Â Â Â Â Â Â Â Â {% endfor %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â 
Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
Â Â Â Â Â Â Â Â Ø§Ù„Ù…Ø¨Ù„Øº:Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„ÙˆØµÙ:Â Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙÂ Â Â Â Â Â Â Â Â Â Â Ø¥ØºÙ„Ø§Ù‚Â Â Â Â Â Â Â Â Â Â Â 
Ø¢Ø®Ø± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
Â Â Â Â Â Â Â Â  Ø¬Ø§Ø±Ù‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„... Â Â Â Â  Â Â Â Â Â Â Â Â Â Â """Â Â Â RECEIPT_HTML = """Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ¹Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ¹
Â Â Â Â  Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„: {{ sale.id }} Â Â Â Â  Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ sale.timestamp }} Â Â Â Â  Â Â Â Â Â Â Â Â  Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {% for it in items %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ it.product.name }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ it.qty }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ it.price }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ (it.qty * it.price)|round(2) }} Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â {% endfor %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â 
Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ sale.total }}
"""Â Â Â ADMIN_HTML = """Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
Â Â Â Â Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹Â Â Â Â Â Â Â {% with messages = get_flashed_messages() %}Â Â Â Â Â Â Â Â Â Â Â {% if messages %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ messages[0] }} Â Â Â Â Â Â Â Â {% endif %}Â Â Â Â Â Â Â {% endwith %}Â Â Â Â Â Â Â 
Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø±Ø§Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬:Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„Ø³Ø¹Ø±:Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„ÙƒÙ…ÙŠØ©:Â Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¶Ø§ÙØ©Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ø±Ø§Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Â Â  Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {% for product in products %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ product.barcode or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ product.name }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ product.price }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {{ product.quantity }} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ØªØ¹Ø¯ÙŠÙ„ |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø­Ø°ÙÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â {% endfor %}Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  """Â Â Â # ---------------- Routes ----------------Â Â Â @app.route('/')Â Â Â def home():Â Â Â Â Â Â Â return render_template_string(HOME_HTML)Â Â Â @app.route('/admin')Â Â Â def admin():Â Â Â Â Â Â Â products = Product.query.order_by(Product.id.desc()).all()Â Â Â Â Â Â Â for p in products:Â Â Â Â Â Â Â Â Â Â Â p.price = decimal_to_str(p.price)Â Â Â Â Â Â Â Â Â Â Â p.quantity = decimal_to_str(p.quantity)Â Â Â Â Â Â Â return render_template_string(ADMIN_HTML, products=products)Â Â Â @app.route('/admin/add', methods=['POST'])Â Â Â def admin_add():Â Â Â Â Â Â Â barcode = request.form.get('barcode') or NoneÂ Â Â Â Â Â Â name = request.form.get('name')Â Â Â Â Â Â Â price = request.form.get('price') or '0'Â Â Â Â Â Â Â qty = request.form.get('qty') or '0'Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â p = Product(barcode=barcode, name=name, price=Decimal(price), quantity=Decimal(qty))Â Â Â Â Â Â Â Â Â Â Â db.session.add(p)Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â flash('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬')Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â flash('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + str(e))Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â @app.route('/admin/delete/')Â Â Â def admin_delete(pid):Â Â Â Â Â Â Â p = Product.query.get_or_404(pid)Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â db.session.delete(p)Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â flash('ØªÙ… Ø§Ù„Ø­Ø°Ù')Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â flash('Ø®Ø·Ø£: ' + str(e))Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â @app.route('/admin/edit/', methods=['GET', 'POST'])Â Â Â def admin_edit(pid):Â Â Â Â Â Â Â product = Product.query.get(pid)Â Â Â Â Â Â Â if not product:Â Â Â Â Â Â Â Â Â Â Â flash('âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')Â Â Â Â Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â Â Â Â Â if request.method == 'POST':Â Â Â Â Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.barcode = request.form.get('barcode') or NoneÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.name = request.form.get('name') or ''Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.price = Decimal(request.form.get('price') or '0')Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.quantity = Decimal(request.form.get('quantity') or '0')Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.unit = request.form.get('unit') or product.unitÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â flash('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­')Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â Â Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â flash('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + str(e))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return redirect(url_for('admin_edit', pid=pid))Â Â Â Â Â Â Â html = f"""Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„Ø§Ø³Ù…:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„Ø³Ø¹Ø±:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„ÙƒÙ…ÙŠØ©:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„ÙˆØ­Ø¯Ø©:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªÂ Â Â Â Â Â Â Â Â Â Â ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â """Â Â Â Â Â Â Â return htmlÂ Â Â @app.route('/admin/stock/', methods=['GET', 'POST'])Â Â Â def admin_stock(pid):Â Â Â Â Â Â Â product = Product.query.get(pid)Â Â Â Â Â Â Â if not product:Â Â Â Â Â Â Â Â Â Â Â flash('âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')Â Â Â Â Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â Â Â Â Â if request.method == 'POST':Â Â Â Â Â Â Â Â Â Â Â action = request.form.get('action')Â Â Â Â Â Â Â Â Â Â Â amount = Decimal(request.form.get('amount') or '0')Â Â Â Â Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if action == 'add':Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.quantity += amountÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â elif action == 'remove':Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.quantity = max(Decimal('0'), product.quantity - amount)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â elif action == 'set':Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â product.quantity = amountÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â flash('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©')Â Â Â Â Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â flash('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©: ' + str(e))Â Â Â Â Â Â Â Â Â Â Â return redirect(url_for('admin'))Â Â Â Â Â Â Â html = f"""Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬: {product.name}
Â Â Â Â Â Â  Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {product.quantity} Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ø§Ù„ÙƒÙ…ÙŠØ©:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â â• Ø²ÙŠØ§Ø¯Ø©Â Â Â Â Â Â Â Â Â Â Â â– Ø¥Ù†Ù‚Ø§ØµÂ Â Â Â Â Â Â Â Â Â Â âš™ï¸ ØªØ¹ÙŠÙŠÙ† ÙƒÙ…ÙŠØ©Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â """Â Â Â Â Â Â Â return htmlÂ Â Â # API lookupÂ Â Â @app.route('/api/product/lookup')Â Â Â def api_lookup():Â Â Â Â Â Â Â q = request.args.get('q', '').strip()Â Â Â Â Â Â Â if not q:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'found': False})Â Â Â Â Â Â Â prod = Product.query.filter((Product.barcode == q) | (db.func.lower(Product.name).like(f"%{q.lower()}%"))).first()Â Â Â Â Â Â Â if not prod:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'found': False})Â Â Â Â Â Â Â res = {Â Â Â Â Â Â Â Â Â Â Â 'id': prod.id,Â Â Â Â Â Â Â Â Â Â Â 'barcode': prod.barcode,Â Â Â Â Â Â Â Â Â Â Â 'name': prod.name,Â Â Â Â Â Â Â Â Â Â Â 'price': decimal_to_str(prod.price),Â Â Â Â Â Â Â Â Â Â Â 'quantity': decimal_to_str(prod.quantity),Â Â Â Â Â Â Â Â Â Â Â 'unit': prod.unitÂ Â Â Â Â Â Â }Â Â Â Â Â Â Â return jsonify({'found': True, 'product': res})Â Â Â # API to create saleÂ Â Â @app.route('/api/sale', methods=['POST'])Â Â Â def api_sale():Â Â Â Â Â Â Â data = request.get_json() or {}Â Â Â Â Â Â Â items = data.get('items', [])Â Â Â Â Â Â Â if not items:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'})Â Â Â Â Â Â Â total = Decimal('0.00')Â Â Â Â Â Â Â sale = Sale(total=Decimal('0.00'))Â Â Â Â Â Â Â db.session.add(sale)Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â for it in items:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â pid = int(it.get('product_id'))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â qty = Decimal(str(it.get('qty')))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â price = Decimal(str(it.get('price')))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â prod = Product.query.get(pid)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if not prod:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â raise Exception(f'Ø§Ù„Ù…Ù†ØªØ¬ {pid} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if prod.quantity is not None and qty > prod.quantity:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â raise Exception(f'ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù„Ù…Ù†ØªØ¬ {prod.name}')Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â prod.quantity = prod.quantity - qtyÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â si = SaleItem(sale=sale, product=prod, qty=qty, price=price)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.add(si)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â total += (qty * price)Â Â Â Â Â Â Â Â Â Â Â sale.total = totalÂ Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True, 'sale_id': sale.id})Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': str(e)})Â Â Â @app.route('/receipt/')Â Â Â def receipt(sale_id):Â Â Â Â Â Â Â sale = Sale.query.get_or_404(sale_id)Â Â Â Â Â Â Â items = sale.itemsÂ Â Â Â Â Â Â for it in items:Â Â Â Â Â Â Â Â Â Â Â it.price = float(it.price)Â Â Â Â Â Â Â Â Â Â Â it.qty = float(it.qty)Â Â Â Â Â Â Â return render_template_string(RECEIPT_HTML, sale=sale, items=items)Â Â Â # ---------------- Reports and new endpoints ----------------Â Â Â @app.route('/reports')Â Â Â def reports():Â Â Â Â Â Â Â today = date.today()Â Â Â Â Â Â Â sales_today = Sale.query.filter(db.func.date(Sale.timestamp) == today).all()Â Â Â Â Â Â Â daily_total = sum([s.total for s in sales_today]) or Decimal('0.00')Â Â Â Â Â Â Â # top productsÂ Â Â Â Â Â Â q = db.session.query(Â Â Â Â Â Â Â Â Â Â Â Product.name,Â Â Â Â Â Â Â Â Â Â Â db.func.sum(SaleItem.qty).label('total_qty'),Â Â Â Â Â Â Â Â Â Â Â db.func.sum(SaleItem.qty * SaleItem.price).label('total_revenue')Â Â Â Â Â Â Â ).join(SaleItem, Product.id == SaleItem.product_id).group_by(Product.id).order_by(db.desc('total_qty')).limit(10)Â Â Â Â Â Â Â top_products = []Â Â Â Â Â Â Â for row in q:Â Â Â Â Â Â Â Â Â Â Â top_products.append({Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'name': row[0],Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'total_qty': decimal_to_str(row[1] or Decimal('0')),Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'total_revenue': decimal_to_str(row[2] or Decimal('0.00'))Â Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â return render_template_string(REPORTS_HTML, daily_total=decimal_to_str(daily_total), top_products=top_products)Â Â Â @app.route('/reports/delete_today', methods=['POST'])Â Â Â def delete_today_sales():Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â today = date.today()Â Â Â Â Â Â Â Â Â Â Â sales_today = Sale.query.filter(db.func.date(Sale.timestamp) == today).all()Â Â Â Â Â Â Â Â Â Â Â ids = [s.id for s in sales_today]Â Â Â Â Â Â Â Â Â Â Â if ids:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â SaleItem.query.filter(SaleItem.sale_id.in_(ids)).delete(synchronize_session=False)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Sale.query.filter(Sale.id.in_(ids)).delete(synchronize_session=False)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True})Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': str(e)})Â Â Â @app.route('/reports/monthly_total')Â Â Â def reports_monthly_total():Â Â Â Â Â Â Â today = date.today()Â Â Â Â Â Â Â month = today.monthÂ Â Â Â Â Â Â year = today.yearÂ Â Â Â Â Â Â sales_month = Sale.query.filter(extract('month', Sale.timestamp) == month, extract('year', Sale.timestamp) == year).all()Â Â Â Â Â Â Â monthly_total = sum([s.total for s in sales_month]) or Decimal('0.00')Â Â Â Â Â Â Â expenses_month = Expense.query.filter(extract('month', Expense.timestamp) == month, extract('year', Expense.timestamp) == year).all()Â Â Â Â Â Â Â expenses_total = sum([e.amount for e in expenses_month]) or Decimal('0.00')Â Â Â Â Â Â Â net = monthly_total - expenses_totalÂ Â Â Â Â Â Â return jsonify({'monthly_total': decimal_to_str(monthly_total), 'monthly_expenses': decimal_to_str(expenses_total), 'net': decimal_to_str(net)})Â Â Â # ---------------- Expenses endpoints ----------------Â Â Â @app.route('/expenses', methods=['GET'])Â Â Â def expenses_page():Â Â Â Â Â Â Â exps = Expense.query.order_by(Expense.timestamp.desc()).limit(100).all()Â Â Â Â Â Â Â arr = [{'id': e.id, 'timestamp': e.timestamp.strftime("%Y-%m-%d %H:%M:%S"), 'amount': decimal_to_str(e.amount), 'description': e.description} for e in exps]Â Â Â Â Â Â Â return jsonify({'expenses': arr})Â Â Â @app.route('/expenses/add', methods=['POST'])Â Â Â def add_expense():Â Â Â Â Â Â Â data = request.get_json() or {}Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â amount = Decimal(str(data.get('amount', '0')))Â Â Â Â Â Â Â Â Â Â Â desc = data.get('description', '')Â Â Â Â Â Â Â Â Â Â Â e = Expense(amount=amount, description=desc)Â Â Â Â Â Â Â Â Â Â Â db.session.add(e)Â Â Â Â Â Â Â Â Â Â Â db.session.commit()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True})Â Â Â Â Â Â Â except Exception as ex:Â Â Â Â Â Â Â Â Â Â Â db.session.rollback()Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': str(ex)})Â Â Â # ---------------- Update endpoints ----------------Â Â Â @app.route('/update/check')Â Â Â def update_check():Â Â Â Â Â Â Â available, path = is_update_available()Â Â Â Â Â Â Â return jsonify({'available': bool(available)})Â Â Â @app.route('/update/apply', methods=['POST'])Â Â Â def update_apply():Â Â Â Â Â Â Â available, path = is_update_available()Â Â Â Â Â Â Â if not available or path is None:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ù…ØªØ§Ø­'})Â Â Â Â Â Â Â ok, info = apply_update_from_zip(path)Â Â Â Â Â Â Â if ok:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True, 'new_version': info})Â Â Â Â Â Â Â else:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': info})Â Â Â # ---------------- Backup endpoints ----------------Â Â Â @app.route('/backup/create', methods=['POST'])Â Â Â def backup_create_route():Â Â Â Â Â Â Â data_file = os.path.join(os.getcwd(), "data.db")Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â create_backup(data_file)Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True})Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': str(e)})Â Â Â @app.route('/backup/restore', methods=['POST'])Â Â Â def backup_restore_route():Â Â Â Â Â Â Â data_file = os.path.join(os.getcwd(), "data.db")Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â restore_backup(data_file)Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': True})Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â return jsonify({'success': False, 'error': str(e)})Â Â Â # ---------------- Shutdown (for exit button) ----------------Â Â Â @app.route('/shutdown', methods=['POST'])Â Â Â def shutdown():Â Â Â Â Â Â Â func = request.environ.get('werkzeug.server.shutdown')Â Â Â Â Â Â Â if func:Â Â Â Â Â Â Â Â Â Â Â func()Â Â Â Â Â Â Â return 'shutting down'Â Â Â # ---------------- Desktop Launcher (PyQt) ----------------Â Â Â def start_desktop_app():Â Â Â Â Â Â Â class POSWindow(QMainWindow):Â Â Â Â Â Â Â Â Â Â Â def init(self):Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â super().init()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.setWindowTitle("Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¹ - Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª")Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.showFullScreen()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â central = QWidget()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.setCentralWidget(central)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â v = QVBoxLayout()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â topbar = QHBoxLayout()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exit_btn = QPushButton("Ø®Ø±ÙˆØ¬")Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exit_btn.setFixedHeight(40)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exit_btn.clicked.connect(self.close_application)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â topbar.addStretch()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â topbar.addWidget(exit_btn)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â v.addLayout(topbar)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.browser = QWebEngineView()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.browser.setUrl(QUrl("http://127.0.0.1:5000/"))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â v.addWidget(self.browser)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â central.setLayout(v)Â Â Â Â Â Â Â Â Â Â Â def close_application(self):Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â import requestsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â requests.post("http://127.0.0.1:5000/shutdown", timeout=1)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â except Exception:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â passÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â QApplication.quit()Â Â Â Â Â Â Â qt_app = QApplication(sys.argv)Â Â Â Â Â Â Â win = POSWindow()Â Â Â Â Â Â Â win.show()Â Â Â Â Â Â Â qt_app.exec_()Â Â Â # ---------------- Main runner ----------------Â Â Â if name == 'main':Â Â Â Â Â Â Â with app.app_context():Â Â Â Â Â Â Â Â Â Â Â init_db()Â Â Â Â Â Â Â def run_flask():Â Â Â Â Â Â Â Â Â Â Â app.run(host='127.0.0.1', port=5000, debug=False, use_reloader=False)Â Â Â Â Â Â Â t = threading.Thread(target=run_flask, daemon=True)Â Â Â Â Â Â Â t.start()Â Â Â Â Â Â Â try:Â Â Â Â Â Â Â Â Â Â Â start_desktop_app()Â Â Â Â Â Â Â except Exception as e:Â Â Â Â Â Â Â Â Â Â Â print("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©:", e)Â Â Â Â Â Â Â Â Â Â Â print("ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ http://127.0.0.1:5000")Â Â 
