
# pos_desktop.py
import zipfile
def check_for_updates():

    """
    ÙŠØ¨Ø­Ø« Ø¹Ù† ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…Ø¬Ù„Ø¯ updates ÙˆÙŠØ­Ø¯Ø« Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
    """
    updates_folder = os.path.join(os.getcwd(), "updates")
    version_file = os.path.join(os.getcwd(), "version.txt")
    # Ù„Ùˆ Ù…ÙÙŠØ´ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø©ØŒ Ù†Ø¹Ù…Ù„Ù‡ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    if not os.path.exists(version_file):
        with open(version_file, "w") as f:
            f.write("1.0")
    # Ù†Ù‚Ø±Ø£ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    with open(version_file, "r") as f:
        current_version = f.read().strip()
    # Ù†Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ØªØ­Ø¯ÙŠØ«
    update_files = [f for f in os.listdir(updates_folder) if f.endswith(".zip")]
    if not update_files:
        return  # Ù…ÙÙŠØ´ ØªØ­Ø¯ÙŠØ«
    update_path = os.path.join(updates_folder, update_files[0])
    update_version = update_files[0].replace(".zip", "")
    # Ù†ØªØ­Ù‚Ù‚ Ù„Ùˆ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø­Ø¯Ø«
    if update_version > current_version:
        print(f"ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ­Ø¯ÙŠØ« {update_version} ...")
        # ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        with zipfile.ZipFile(update_path, "r") as zip_ref:
            zip_ref.extractall(os.getcwd())
        # ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù†Ø³Ø®Ø©
        with open(version_file, "w") as f:
            f.write(update_version)
        print("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­!")
    else:
        print("ğŸš€ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø­Ø¯Ø« Ø¨Ø§Ù„ÙØ¹Ù„.")


from flask import Flask, render_template_string, request, redirect, url_for, jsonify, flash
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime, date
from decimal import Decimal
import threading
import sys
import os
import os
import win32print
import win32api
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from datetime import datetime
import threading
import time
from PyQt5.QtWidgets import QMessageBox
# ğŸ–¨ï¸ Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
current_printer = None
def monitor_printers(callback):
    """Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ ÙˆØªÙ†ÙÙŠØ° callback Ù„Ùˆ ØªÙ… ØªÙˆØµÙŠÙ„ Ø·Ø§Ø¨Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    global current_printer
    while True:
        try:
            printers = [p[2] for p in win32print.EnumPrinters(2)]
            if printers:
                default_printer = win32print.GetDefaultPrinter()
                if default_printer != current_printer:
                    current_printer = default_printer
                    callback(current_printer)
            time.sleep(55)  # ÙØ­Øµ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        except Exception:
            time.sleep(12)
def on_new_printer_detected(printer_name):
    """ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø·Ø§Ø¨Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    print(f"âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø·Ø§Ø¨Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©: {printer_name}")
def print_invoice_auto(invoice_data):
    """
    invoice_data = {
        "invoice_id": 123,
        "store_name": " Ø¨ÙŠØ¹ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª",
        "products": [
            {"name": "Ø¨ÙŠØ¨Ø³ÙŠ", "price": 15.5, "quantity": 2},
            {"name": "Ø´ÙŠØ¨Ø³ÙŠ", "price": 10, "quantity": 3}
        ],
        "total": 61.0
    }
    """
    # ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù PDF Ù…Ø¤Ù‚Øª Ù„Ù„ÙØ§ØªÙˆØ±Ø©
    file_name = f"invoice_{invoice_data['invoice_id']}.pdf"
    pdf_path = os.path.join(os.getcwd(), file_name)
    c = canvas.Canvas(pdf_path, pagesize=A4)
    width, height = A4
    c.setFont("Helvetica-Bold", 18)
    c.drawCentredString(width / 2, height - 50, invoice_data["store_name"])
    c.setFont("Helvetica", 12)
    c.drawString(40, height - 80, f"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {invoice_data['invoice_id']}")
    c.drawString(400, height - 80, f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}")
    y = height - 120
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y, "Ø§Ù„Ù…Ù†ØªØ¬")
    c.drawString(250, y, "Ø§Ù„Ø³Ø¹Ø±")
    c.drawString(350, y, "Ø§Ù„ÙƒÙ…ÙŠØ©")
    c.drawString(450, y, "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ")
    c.setFont("Helvetica", 11)
    y -= 20
    for item in invoice_data["products"]:
        total_price = item["price"] * item["quantity"]
        c.drawString(50, y, item["name"])
        c.drawString(250, y, f"{item['price']:.2f}")
        c.drawString(350, y, str(item["quantity"]))
        c.drawString(450, y, f"{total_price:.2f}")
        y -= 20
    c.setFont("Helvetica-Bold", 13)
    c.drawString(50, y - 20, f"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: {invoice_data['total']:.2f} Ø¬Ù†ÙŠÙ‡")
    c.showPage()
    c.save()
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ø§Ø¨Ø¹Ø© Ù…ØªØµÙ„Ø©
    try:
        printer_name = win32print.GetDefaultPrinter()
        if printer_name:
            print(f"ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰: {printer_name}")
            win32api.ShellExecute(0, "print", pdf_path, None, ".", 0)
        else:
            raise Exception("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ø¨Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©")
    except Exception:
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Warning)
        msg.setWindowTitle("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
        msg.setText("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ø¨Ø¹Ø© Ù…ØªØµÙ„Ø©!\nØ³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¯Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.")
        msg.exec_()
        os.startfile(pdf_path)
# ğŸ§  ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø´ÙƒÙ„ Ù‡Ø§Ø¯Ø¦)
thread = threading.Thread(target=monitor_printers, args=(on_new_printer_detected,), daemon=True)
thread.start()
# ---------------- Flask App & DB ----------------
app = Flask(__name__)

app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///data.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SECRET_KEY'] = 'replace-this-with-a-secure-key'
db = SQLAlchemy(app)
# --------- Models ---------
class Product(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    barcode = db.Column(db.String(64), unique=True, nullable=True)
    name = db.Column(db.String(200), nullable=False)
    price = db.Column(db.Numeric(10, 2), nullable=False)
    cost = db.Column(db.Numeric(10, 2), nullable=True)
    quantity = db.Column(db.Numeric(10, 3), nullable=False, default=0)
    unit = db.Column(db.String(20), default='pcs')
    expiry = db.Column(db.Date, nullable=True)
class Sale(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    total = db.Column(db.Numeric(12, 2), nullable=False)
    items = db.relationship('SaleItem', backref='sale', cascade='all, delete-orphan')
class SaleItem(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    sale_id = db.Column(db.Integer, db.ForeignKey('sale.id'), nullable=False)
    product_id = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False)
    product = db.relationship('Product')
    qty = db.Column(db.Numeric(10, 3), nullable=False)
    price = db.Column(db.Numeric(10, 2), nullable=False)
# --------- Helpers ---------
def init_db():
    db.create_all()
    # add some sample products if empty
    if Product.query.count() == 0:
        p1 = Product(barcode='6291041500213', name='Ø£Ø±Ø² 1ÙƒØ¬Ù…', price=Decimal('40.00'), cost=Decimal('30.00'), quantity=Decimal('50'), unit='kg')
        p2 = Product(barcode='6291041500214', name='Ø­Ù„ÙŠØ¨ 1Ù„ØªØ±', price=Decimal('25.00'), cost=Decimal('18.00'), quantity=Decimal('100'), unit='pcs')
        p3 = Product(barcode='6291041500215', name='Ø³ÙƒØ± 1ÙƒØ¬Ù…', price=Decimal('35.00'), cost=Decimal('25.00'), quantity=Decimal('40'), unit='kg')
        db.session.add_all([p1, p2, p3])
        db.session.commit()
def decimal_to_str(d):
    if d is None:
        return None
    return format(d, 'f')
# ---------------- Templates (from your code, completed) ----------------
HOME_HTML = """..."""  # placeholder below replaced dynamically to keep message short
# We'll insert full HTML templates programmatically below to avoid massive duplication in assistant reply.
# (To keep readability here, we'll set templates as variables below)
HOME_HTML = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ø§Ø³ØªÙ… - Ù„Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ø¹Ù…Ø§Ù„</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; margin: 0; padding: 20px; direction: rtl; }
        h1, h2 { color: #fff; text-align: center; }
        input, button { padding: 10px; margin: 5px; border: none; border-radius: 5px; font-size: 16px; }
        button { background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #f2f2f2; }
        #total { font-weight: bold; color: #ff5722; }
        .exit-btn { background: #f44336; position: fixed; top: 10px; left: 10px; padding: 8px 12px; border-radius: 6px; color: white; }
        .exit-btn:hover { background: #d32f2f; }
    </style>
</head>
<body>
    <button class="exit-btn" onclick="fetch('/shutdown', {method:'POST'}).then(()=>{window.close();})">Ø®Ø±ÙˆØ¬</button>
    
    <h1>Ø³Ø³ØªÙ…  - Ù„Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ø§Ø¹Ù…Ø§Ù„ (ÙØ±Ø¹ ÙˆØ§Ø­Ø¯)</h1>
    <h2>Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø³Ø­ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ø³Ù…)</h2>
    <input type="text" id="lookup" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" onkeypress="if(event.key === 'Enter') lookupProduct();">
    <button onclick="lookupProduct()">Ø¥Ø¶Ø§ÙØ©</button>
    <div id="product-info" style="color: red;"></div>
    <h2>Ø§Ù„Ø³Ù„Ø©</h2>
    <table>
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody id="cart-table"></tbody>
    </table>
    <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0.00</span> Ø¬Ù†ÙŠÙ‡ </p>
    <button onclick="completeSale()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹</button>
    <button onclick="printReceipt()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
    <p><a href="/admin">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</a> | <a href="/reports">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a></p>
    <script>
        let cart = [];
        let lastSaleId = null;
        function lookupProduct() {
            const q = document.getElementById('lookup').value.trim();
            if (!q) return;
            fetch('/api/product/lookup?q=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(data => {
                    if (data.found) {
                        addToCart(data.product);
                        document.getElementById('lookup').value = '';
                        document.getElementById('product-info').innerText = '';
                    } else {
                        document.getElementById('product-info').innerText = 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                    }
                });
        }
        function addToCart(product) {
            const qty = parseFloat(prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©:', '1')) || 1;
            if (qty <= 0) return;
            const existing = cart.find(i => i.id === product.id);
            if (existing) existing.qty += qty;
            else cart.push({id: product.id, name: product.name, qty: qty, price: parseFloat(product.price)});
            updateCart();
        }
        function updateCart() {
            const table = document.getElementById('cart-table');
            table.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const rowTotal = item.qty * item.price;
                total += rowTotal;
                table.innerHTML += `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price.toFixed(2)}</td><td>${rowTotal.toFixed(2)}</td><td><button onclick="removeFromCart(${item.id})">Ø¥Ø²Ø§Ù„Ø©</button></td></tr>`;
            });
            document.getElementById('total').innerText = total.toFixed(2);
        }
        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCart();
        }
        function completeSale() {
            if (cart.length === 0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
            const items = cart.map(i => ({product_id: i.id, qty: i.qty, price: i.price}));
            fetch('/api/sale', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({items: items}) })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹! Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ¹: ' + data.sale_id);
                        lastSaleId = data.sale_id;
                        cart = [];
                        updateCart();
                    } else {
                        alert('Ø®Ø·Ø£: ' + data.error);
                    }
                });
        }
        function printReceipt() {
            if (lastSaleId) {
                window.open('/receipt/' + lastSaleId, '_blank');
            } else {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø·Ø¨Ø¹Ù‡');
            }
        }
    </script>
</body>
</html>
"""
ADMIN_HTML = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f4f4f4; margin: 20px; direction: rtl; }
        h1, h2 { color: #333; }
        form { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        button { padding: 10px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #1976D2; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 10px; text-align: center; border: 1px solid #ddd; }
        th { background: #eee; }
        .flash { color: red; }
    </style>
</head>
<body>
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
    <a href="/">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</a>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash">{{ messages[0] }}</div>
        {% endif %}
    {% endwith %}
    <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h2>
    <form method="POST" action="/admin/add">
        Ø±Ø§Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬: <input name="barcode"><br>
        Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: <input name="name" required><br>
        Ø§Ù„Ø³Ø¹Ø±: <input name="price" type="number" step="0.01" required><br>
        Ø§Ù„ÙƒÙ…ÙŠØ©: <input name="qty" type="number" step="0.001" value="0"><br>
        <button type="submit">Ø¥Ø¶Ø§ÙØ©</button>
    </form>
    <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <table>
        <thead>
            <tr><th>Ø±Ø§Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬  </th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.barcode or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.price }}</td>
                <td>{{ product.quantity }}</td>
                <td>
                    <a href="/admin/edit/{{ product.id }}">ØªØ¹Ø¯ÙŠÙ„</a> | 
                    <a href="/admin/stock/{{ product.id }}">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a> | 
                    <a href="/admin/delete/{{ product.id }}" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')">Ø­Ø°Ù</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
"""
REPORTS_HTML = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f4f4f4; margin: 20px; direction: rtl; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 10px; text-align: center; border: 1px solid #ddd; }
        th { background: #eee; }
    </style>
</head>
<body>
    <h1>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
    <a href="/">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</a>
    <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: {{ daily_total }} Ø¬Ù†ÙŠÙ‡ </p>
    <h2>Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ù‹Ø§</h2>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th></tr>
        </thead>
        <tbody>
            {% for item in top_products %}
            <tr><td>{{ item.name }}</td><td>{{ item.total_qty }}</td><td>{{ item.total_revenue }}</td></tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
"""
RECEIPT_HTML = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ¹</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; direction: rtl; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 6px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>
    <h1>Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ¹</h1>
    <p>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„: {{ sale.id }}</p>
    <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ sale.timestamp }}</p>
    <table>
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
        <tbody>
            {% for it in items %}
            <tr>
                <td>{{ it.product.name }}</td>
                <td>{{ it.qty }}</td>
                <td>{{ it.price }}</td>
                <td>{{ (it.qty * it.price)|round(2) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ sale.total }}</h3>
</body>
</html>
"""
# ---------------- Routes ----------------
@app.route('/')
def home():
    return render_template_string(HOME_HTML)
@app.route('/admin')
def admin():
    products = Product.query.order_by(Product.id.desc()).all()
    # convert displayable values
    for p in products:
        p.price = decimal_to_str(p.price)
        p.quantity = decimal_to_str(p.quantity)
    return render_template_string(ADMIN_HTML, products=products)
@app.route('/admin/add', methods=['POST'])
def admin_add():
    barcode = request.form.get('barcode') or None
    name = request.form.get('name')
    price = request.form.get('price') or '0'
    qty = request.form.get('qty') or '0'
    try:
        p = Product(barcode=barcode, name=name, price=Decimal(price), quantity=Decimal(qty))
        db.session.add(p)
        db.session.commit()
        flash('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬')
    except Exception as e:
        db.session.rollback()
        flash('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + str(e))
    return redirect(url_for('admin'))
@app.route('/admin/delete/<int:pid>')
def admin_delete(pid):
    p = Product.query.get_or_404(pid)
    try:
        db.session.delete(p)
        db.session.commit()
        flash('ØªÙ… Ø§Ù„Ø­Ø°Ù')
    except Exception as e:
        db.session.rollback()
        flash('Ø®Ø·Ø£: ' + str(e))
    return redirect(url_for('admin'))
@app.route('/reports')
def reports():
    today = date.today()
    sales_today = Sale.query.filter(db.func.date(Sale.timestamp) == today).all()
    daily_total = sum([s.total for s in sales_today]) or Decimal('0.00')
    # top products
    q = db.session.query(
        Product.name,
        db.func.sum(SaleItem.qty).label('total_qty'),
        db.func.sum(SaleItem.qty * SaleItem.price).label('total_revenue')
    ).join(SaleItem, Product.id == SaleItem.product_id).group_by(Product.id).order_by(db.desc('total_qty')).limit(10)
    top_products = []
    for row in q:
        top_products.append({
            'name': row[0],
            'total_qty': decimal_to_str(row[1] or Decimal('0')),
            'total_revenue': decimal_to_str(row[2] or Decimal('0.00'))
        })
    return render_template_string(REPORTS_HTML, daily_total=decimal_to_str(daily_total), top_products=top_products)
# API lookup: search by barcode or name substring
@app.route('/api/product/lookup')
def api_lookup():
    q = request.args.get('q', '').strip()
    if not q:
        return jsonify({'found': False})
    # try exact barcode
    prod = Product.query.filter((Product.barcode == q) | (db.func.lower(Product.name).like(f"%{q.lower()}%"))).first()
    if not prod:
        return jsonify({'found': False})
    res = {
        'id': prod.id,
        'barcode': prod.barcode,
        'name': prod.name,
        'price': decimal_to_str(prod.price),
        'quantity': decimal_to_str(prod.quantity),
        'unit': prod.unit
    }
    return jsonify({'found': True, 'product': res})
# API to create sale
@app.route('/api/sale', methods=['POST'])
def api_sale():
    data = request.get_json() or {}
    items = data.get('items', [])
    if not items:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'})
    total = Decimal('0.00')
    sale = Sale(total=Decimal('0.00'))
    db.session.add(sale)
    try:
        for it in items:
            pid = int(it.get('product_id'))
            qty = Decimal(str(it.get('qty')))
            price = Decimal(str(it.get('price')))
            prod = Product.query.get(pid)
            if not prod:
                raise Exception(f'Ø§Ù„Ù…Ù†ØªØ¬ {pid} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')
            # check stock
            if prod.quantity is not None and qty > prod.quantity:
                raise Exception(f'ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù„Ù…Ù†ØªØ¬ {prod.name}')
            # deduct
            prod.quantity = prod.quantity - qty
            si = SaleItem(sale=sale, product=prod, qty=qty, price=price)
            db.session.add(si)
            total += (qty * price)
        sale.total = total
        db.session.commit()
        return jsonify({'success': True, 'sale_id': sale.id})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'error': str(e)})
@app.route('/receipt/<int:sale_id>')
def receipt(sale_id):
    sale = Sale.query.get_or_404(sale_id)
    items = sale.items
    # convert numeric types for template display
    for it in items:
        it.price = float(it.price)
        it.qty = float(it.qty)
    return render_template_string(RECEIPT_HTML, sale=sale, items=items)
# A shutdown route to allow UI button to close the server cleanly
@app.route('/shutdown', methods=['POST'])
def shutdown():
    func = request.environ.get('werkzeug.server.shutdown')
    if func:
        func()
    return 'shutting down'
# ---------------- Desktop Launcher (PyQt) ----------------
from decimal import Decimal
from flask import flash, redirect, url_for, request
# ---------- ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ----------
@app.route('/admin/edit/<int:pid>', methods=['GET', 'POST'])
def admin_edit(pid):
    product = Product.query.get(pid)
    if not product:
        flash('âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')
        return redirect(url_for('admin'))
    if request.method == 'POST':
        try:
            product.barcode = request.form.get('barcode') or None
            product.name = request.form.get('name') or ''
            product.price = Decimal(request.form.get('price') or '0')
            product.quantity = Decimal(request.form.get('quantity') or '0')
            product.unit = request.form.get('unit') or product.unit
            db.session.commit()
            flash('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­')
            return redirect(url_for('admin'))
        except Exception as e:
            db.session.rollback()
            flash('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + str(e))
            return redirect(url_for('admin_edit', pid=pid))
    # ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    html = f"""
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="utf-8">
      <title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</title>
      <style>
        body {{ font-family: Arial; direction: rtl; padding: 20px; background: #fafafa; }}
        input, button {{ font-size: 16px; padding: 8px; margin: 5px; }}
        label {{ display: block; margin-top: 10px; }}
      </style>
    </head>
    <body>
      <h2>ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
      <form method="POST">
        <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:</label>
        <input name="barcode" value="{product.barcode or ''}">
        <label>Ø§Ù„Ø§Ø³Ù…:</label>
        <input name="name" required value="{product.name}">
        <label>Ø§Ù„Ø³Ø¹Ø±:</label>
        <input name="price" type="number" step="0.01" value="{product.price}">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
        <input name="quantity" type="number" step="0.001" value="{product.quantity}">
        <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
        <input name="unit" value="{product.unit}">
        <br><br>
        <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <a href="{ url_for('admin') }"><button type="button">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button></a>
      </form>
    </body>
    </html>
    """
    return html
# ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ----------
@app.route('/admin/stock/<int:pid>', methods=['GET', 'POST'])
def admin_stock(pid):
    product = Product.query.get(pid)
    if not product:
        flash('âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')
        return redirect(url_for('admin'))
    if request.method == 'POST':
        action = request.form.get('action')
        amount = Decimal(request.form.get('amount') or '0')
        try:
            if action == 'add':
                product.quantity += amount
            elif action == 'remove':
                product.quantity = max(Decimal('0'), product.quantity - amount)
            elif action == 'set':
                product.quantity = amount
            db.session.commit()
            flash('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©')
        except Exception as e:
            db.session.rollback()
            flash('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©: ' + str(e))
        return redirect(url_for('admin'))
    html = f"""
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="utf-8">
      <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
      <style>
        body {{ font-family: Arial; direction: rtl; padding: 20px; background: #fafafa; }}
        input, button {{ font-size: 16px; padding: 8px; margin: 5px; }}
        label {{ display: block; margin-top: 10px; }}
      </style>
    </head>
    <body>
      <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬: {product.name}</h2>
      <p>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {product.quantity}</p>
      <form method="POST">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
        <input name="amount" type="number" step="0.001" required value="1"><br><br>
        <button name="action" value="add">â• Ø²ÙŠØ§Ø¯Ø©</button>
        <button name="action" value="remove">â– Ø¥Ù†Ù‚Ø§Øµ</button>
        <button name="action" value="set">âš™ï¸ ØªØ¹ÙŠÙŠÙ† ÙƒÙ…ÙŠØ©</button>
      </form>
      <br>
      <a href="{ url_for('admin') }"><button type="button">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button></a>
    </body>
    </html>
    """
    return html
def start_desktop_app():
    # import here to keep Flask-only usage possible if not running desktop
    from PyQt5.QtWidgets import QApplication, QMainWindow, QVBoxLayout, QWidget, QPushButton, QHBoxLayout
    from PyQt5.QtWebEngineWidgets import QWebEngineView
    from PyQt5.QtCore import QUrl, Qt
    class POSWindow(QMainWindow):
        def __init__(self):
            super().__init__()
            self.setWindowTitle("Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¹ - Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª")
            # Fullscreen:
            self.showFullScreen()
            # central widget
            central = QWidget()
            self.setCentralWidget(central)
            v = QVBoxLayout()
            # top controls (exit)
            topbar = QHBoxLayout()
            exit_btn = QPushButton("Ø®Ø±ÙˆØ¬")
            exit_btn.setFixedHeight(40)
            exit_btn.clicked.connect(self.close_application)
            topbar.addStretch()
            topbar.addWidget(exit_btn)
            v.addLayout(topbar)
            # web view
            self.browser = QWebEngineView()
            self.browser.setUrl(QUrl("http://127.0.0.1:5000/"))
            v.addWidget(self.browser)
            central.setLayout(v)
        def close_application(self):
            # try to call shutdown route to stop flask then close app
            try:
                import requests
                requests.post("http://127.0.0.1:5000/shutdown", timeout=1)
            except Exception:
                pass
            QApplication.quit()
    # start qt app
    qt_app = QApplication(sys.argv)
    win = POSWindow()
    win.show()
    qt_app.exec_()
#__________________Ø§Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ù‡ Ø§Ø­Ø·ÙŠØ§Ø·ÙŠÙ‡_________________
import os
import shutil
import datetime
from PyQt5.QtWidgets import QMessageBox
def create_backup(data_file_path):
    """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        if not os.path.exists(data_file_path):
            raise FileNotFoundError("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        backup_dir = os.path.join(os.getcwd(), "backup")
        os.makedirs(backup_dir, exist_ok=True)
        # Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        file_name = os.path.basename(data_file_path)
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_name = f"backup_{timestamp}_{file_name}"
        backup_path = os.path.join(backup_dir, backup_name)
        shutil.copy2(data_file_path, backup_path)
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­: {backup_name}")
    except Exception as e:
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Warning)
        msg.setWindowTitle("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ")
        msg.setText(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:\n{e}")
        msg.exec_()
def restore_backup(data_file_path):
    """Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"""
    try:
        backup_dir = os.path.join(os.getcwd(), "backup")
        if not os.path.exists(backup_dir) or not os.listdir(backup_dir):
            raise FileNotFoundError("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.")
        # Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®
        backups = sorted(os.listdir(backup_dir), reverse=True)
        latest_backup = backups[0]
        latest_backup_path = os.path.join(backup_dir, latest_backup)
        shutil.copy2(latest_backup_path, data_file_path)
        print(f"â™»ï¸ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø©: {latest_backup}")
    except Exception as e:
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Warning)
        msg.setWindowTitle("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹")
        msg.setText(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:\n{e}")
        msg.exec_()

# ---------------- Main runner ----------------
if __name__ == '__main__':
    # ensure DB and sample data
    with app.app_context():
        init_db()
    # run flask in background thread
    def run_flask():
        # host localhost, port 5000
        app.run(host='127.0.0.1', port=5000, debug=False, use_reloader=False)
    t = threading.Thread(target=run_flask, daemon=True)
    t.start()
    # start desktop UI (this will open full-screen window with the POS)
    try:
        start_desktop_app()
    except Exception as e:
        print("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©:", e)
        print("ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ http://127.0.0.1:5000")
